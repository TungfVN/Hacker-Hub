-- Fly GUI with Beautiful Animation
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- Create ScreenGui
local flyGui = Instance.new("ScreenGui")
flyGui.Name = "FlyGUI"
flyGui.Parent = playerGui

-- Toggle button to show/hide UI
local toggleButton = Instance.new("ImageButton")
toggleButton.Name = "ToggleButton"
toggleButton.Size = UDim2.new(0, 60, 0, 60)
toggleButton.Position = UDim2.new(0, 20, 0, 20)
toggleButton.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
toggleButton.BackgroundTransparency = 0.2
toggleButton.Image = "rbxassetid://86019416633420"
toggleButton.ScaleType = Enum.ScaleType.Fit
toggleButton.ZIndex = 10
toggleButton.Parent = flyGui

local toggleCorner = Instance.new("UICorner")
toggleCorner.CornerRadius = UDim.new(0, 12)
toggleCorner.Parent = toggleButton

local toggleStroke = Instance.new("UIStroke")
toggleStroke.Color = Color3.fromRGB(80, 80, 80)
toggleStroke.Thickness = 2
toggleStroke.Parent = toggleButton

-- Create Main Frame (Transparent)
local mainFrame = Instance.new("Frame")
mainFrame.Name = "MainFrame"
mainFrame.Size = UDim2.new(0, 280, 0, 200)
mainFrame.Position = UDim2.new(0.5, -140, 0.5, -100)
mainFrame.AnchorPoint = Vector2.new(0.5, 0.5)
mainFrame.BackgroundColor3 = Color3.fromRGB(10, 10, 10)
mainFrame.BackgroundTransparency = 0.3
mainFrame.BorderSizePixel = 0
mainFrame.Visible = false
mainFrame.Parent = flyGui

-- Add shadow effect
local uiCorner = Instance.new("UICorner")
uiCorner.CornerRadius = UDim.new(0, 16)
uiCorner.Parent = mainFrame

local uiStroke = Instance.new("UIStroke")
uiStroke.Color = Color3.fromRGB(60, 60, 60)
uiStroke.Thickness = 2
uiStroke.Parent = mainFrame

-- Speed display (Semi-transparent)
local speedDisplay = Instance.new("TextLabel")
speedDisplay.Name = "SpeedDisplay"
speedDisplay.Size = UDim2.new(1, -40, 0, 40)
speedDisplay.Position = UDim2.new(0, 20, 0, 20)
speedDisplay.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
speedDisplay.BackgroundTransparency = 0.4
speedDisplay.Text = "SPEED: 50"
speedDisplay.TextColor3 = Color3.fromRGB(220, 220, 220)
speedDisplay.TextScaled = true
speedDisplay.Font = Enum.Font.GothamBold
speedDisplay.Parent = mainFrame

local speedCorner = Instance.new("UICorner")
speedCorner.CornerRadius = UDim.new(0, 10)
speedCorner.Parent = speedDisplay

local speedStroke = Instance.new("UIStroke")
speedStroke.Color = Color3.fromRGB(70, 70, 70)
speedStroke.Thickness = 1
speedStroke.Parent = speedDisplay

-- Container for speed control buttons
local speedControls = Instance.new("Frame")
speedControls.Name = "SpeedControls"
speedControls.Size = UDim2.new(1, -40, 0, 50)
speedControls.Position = UDim2.new(0, 20, 0, 75)
speedControls.BackgroundTransparency = 1
speedControls.Parent = mainFrame

-- Decrease speed button (Semi-transparent)
local decreaseButton = Instance.new("TextButton")
decreaseButton.Name = "DecreaseButton"
decreaseButton.Size = UDim2.new(0.4, 0, 1, 0)
decreaseButton.Position = UDim2.new(0, 0, 0, 0)
decreaseButton.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
decreaseButton.BackgroundTransparency = 0.3
decreaseButton.Text = "-"
decreaseButton.TextColor3 = Color3.fromRGB(255, 255, 255)
decreaseButton.TextScaled = true
decreaseButton.Font = Enum.Font.GothamBlack
decreaseButton.Parent = speedControls

local decCorner = Instance.new("UICorner")
decCorner.CornerRadius = UDim.new(0, 8)
decCorner.Parent = decreaseButton

local decStroke = Instance.new("UIStroke")
decStroke.Color = Color3.fromRGB(80, 80, 80)
decStroke.Thickness = 1
decStroke.Parent = decreaseButton

-- Increase speed button (Semi-transparent)
local increaseButton = Instance.new("TextButton")
increaseButton.Name = "IncreaseButton"
increaseButton.Size = UDim2.new(0.4, 0, 1, 0)
increaseButton.Position = UDim2.new(0.6, 0, 0, 0)
increaseButton.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
increaseButton.BackgroundTransparency = 0.3
increaseButton.Text = "+"
increaseButton.TextColor3 = Color3.fromRGB(255, 255, 255)
increaseButton.TextScaled = true
increaseButton.Font = Enum.Font.GothamBlack
increaseButton.Parent = speedControls

local incCorner = Instance.new("UICorner")
incCorner.CornerRadius = UDim.new(0, 8)
incCorner.Parent = increaseButton

local incStroke = Instance.new("UIStroke")
incStroke.Color = Color3.fromRGB(80, 80, 80)
incStroke.Thickness = 1
incStroke.Parent = increaseButton

-- Main Fly button (Semi-transparent)
local flyButton = Instance.new("TextButton")
flyButton.Name = "FlyButton"
flyButton.Size = UDim2.new(1, -40, 0, 50)
flyButton.Position = UDim2.new(0, 20, 0, 140)
flyButton.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
flyButton.BackgroundTransparency = 0.3
flyButton.Text = "START FLYING"
flyButton.TextColor3 = Color3.fromRGB(220, 220, 220)
flyButton.TextScaled = true
flyButton.Font = Enum.Font.GothamBold
flyButton.Parent = mainFrame

local flyCorner = Instance.new("UICorner")
flyCorner.CornerRadius = UDim.new(0, 12)
flyCorner.Parent = flyButton

local flyStroke = Instance.new("UIStroke")
flyStroke.Color = Color3.fromRGB(70, 70, 70)
flyStroke.Thickness = 1
flyStroke.Parent = flyButton

-- Control variables
local isFlying = false
local flySpeed = 50
local bodyVelocity
local bodyGyro
local isDragging = false
local dragStart
local dragStartPosition
local isUIOpen = false
local isAnimating = false

-- Update speed display
local function updateSpeedDisplay()
    speedDisplay.Text = "SPEED: " .. flySpeed
end

-- Safe character check function
local function getCharacter()
    local character = player.Character
    if character and character:IsDescendantOf(workspace) then
        return character
    end
    return nil
end

-- Beautiful open animation
local function openUI()
    if isAnimating or isUIOpen then return end
    
    isAnimating = true
    mainFrame.Visible = true
    
    -- Reset properties for animation
    mainFrame.Size = UDim2.new(0, 0, 0, 0)
    mainFrame.Position = UDim2.new(0.5, 0, 0.5, 0)
    mainFrame.BackgroundTransparency = 1
    mainFrame.Rotation = -10
    
    -- Scale up with bounce effect
    local scaleTween = TweenService:Create(mainFrame, TweenInfo.new(0.6, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {
        Size = UDim2.new(0, 280, 0, 200),
        BackgroundTransparency = 0.3
    })
    
    -- Position animation
    local positionTween = TweenService:Create(mainFrame, TweenInfo.new(0.5, Enum.EasingStyle.Quart, Enum.EasingDirection.Out), {
        Position = UDim2.new(0.5, -140, 0.5, -100)
    })
    
    -- Rotation animation for entrance effect
    local rotationTween = TweenService:Create(mainFrame, TweenInfo.new(0.4, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
        Rotation = 0
    })
    
    -- Toggle button animation
    local toggleTween = TweenService:Create(toggleButton, TweenInfo.new(0.5, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {
        Rotation = 180,
        Position = UDim2.new(0, 20, 0, 20)
    })
    
    -- Start animations
    scaleTween:Play()
    positionTween:Play()
    rotationTween:Play()
    toggleTween:Play()
    
    -- Fade in elements after a short delay
    delay(0.2, function()
        local elements = {speedDisplay, decreaseButton, increaseButton, flyButton}
        for _, element in pairs(elements) do
            element.BackgroundTransparency = 1
            local tween = TweenService:Create(element, TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
                BackgroundTransparency = element == speedDisplay and 0.4 or 0.3
            })
            tween:Play()
        end
    end)
    
    scaleTween.Completed:Connect(function()
        isUIOpen = true
        isAnimating = false
    end)
end

-- Beautiful close animation
local function closeUI()
    if isAnimating or not isUIOpen then return end
    
    isAnimating = true
    
    -- Fade out elements first
    local elements = {speedDisplay, decreaseButton, increaseButton, flyButton}
    for _, element in pairs(elements) do
        local tween = TweenService:Create(element, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
            BackgroundTransparency = 1
        })
        tween:Play()
    end
    
    -- Wait a bit then close the frame
    delay(0.1, function()
        -- Scale down with smooth effect
        local scaleTween = TweenService:Create(mainFrame, TweenInfo.new(0.4, Enum.EasingStyle.Back, Enum.EasingDirection.In), {
            Size = UDim2.new(0, 0, 0, 0),
            BackgroundTransparency = 1
        })
        
        -- Rotation animation for exit effect
        local rotationTween = TweenService:Create(mainFrame, TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
            Rotation = 10
        })
        
        -- Move to center
        local positionTween = TweenService:Create(mainFrame, TweenInfo.new(0.4, Enum.EasingStyle.Quart, Enum.EasingDirection.Out), {
            Position = UDim2.new(0.5, 0, 0.5, 0)
        })
        
        -- Toggle button animation
        local toggleTween = TweenService:Create(toggleButton, TweenInfo.new(0.4, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {
            Rotation = 0
        })
        
        -- Start animations
        scaleTween:Play()
        positionTween:Play()
        rotationTween:Play()
        toggleTween:Play()
        
        scaleTween.Completed:Connect(function()
            mainFrame.Visible = false
            mainFrame.Rotation = 0
            mainFrame.BackgroundTransparency = 0.3
            isUIOpen = false
            isAnimating = false
            
            -- Reset element transparency
            for _, element in pairs(elements) do
                element.BackgroundTransparency = element == speedDisplay and 0.4 or 0.3
            end
        end)
    end)
end

-- Toggle UI function
local function toggleUI()
    if isAnimating then return end
    
    if isUIOpen then
        closeUI()
    else
        openUI()
    end
end

-- True camera direction flying function
local function startFlying()
    if isFlying then return end
    
    local character = getCharacter()
    if not character then return end
    
    local humanoid = character:FindFirstChild("Humanoid")
    local rootPart = character:FindFirstChild("HumanoidRootPart")
    
    if not humanoid or not rootPart then return end
    
    isFlying = true
    flyButton.Text = "STOP FLYING"
    flyButton.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    flyButton.BackgroundTransparency = 0.2
    
    -- Create BodyVelocity for movement
    bodyVelocity = Instance.new("BodyVelocity")
    bodyVelocity.Velocity = Vector3.new(0, 0, 0)
    bodyVelocity.MaxForce = Vector3.new(4000, 4000, 4000)
    bodyVelocity.Parent = rootPart
    
    -- Create BodyGyro for stability
    bodyGyro = Instance.new("BodyGyro")
    bodyGyro.MaxTorque = Vector3.new(4000, 4000, 4000)
    bodyGyro.P = 1000
    bodyGyro.D = 50
    bodyGyro.Parent = rootPart
    
    humanoid.PlatformStand = true
    
    -- Connect input events for true camera direction movement
    local moveConnection
    moveConnection = RunService.Heartbeat:Connect(function()
        if not isFlying or not bodyVelocity then
            if moveConnection then
                moveConnection:Disconnect()
            end
            return
        end
        
        local currentCharacter = getCharacter()
        if not currentCharacter then
            if moveConnection then
                moveConnection:Disconnect()
            end
            return
        end
        
        local currentRootPart = currentCharacter:FindFirstChild("HumanoidRootPart")
        if not currentRootPart then return end
        
        local direction = Vector3.new(0, 0, 0)
        local camera = workspace.CurrentCamera
        
        if camera then
            -- Get camera vectors
            local cameraCFrame = camera.CFrame
            local lookVector = cameraCFrame.LookVector  -- Forward direction
            local rightVector = cameraCFrame.RightVector  -- Right direction
            
            -- True camera-relative movement
            if UserInputService:IsKeyDown(Enum.KeyCode.W) then
                -- Forward - follow exact camera look direction
                direction = direction + lookVector
            end
            if UserInputService:IsKeyDown(Enum.KeyCode.S) then
                -- Backward - opposite of camera look direction
                direction = direction - lookVector
            end
            if UserInputService:IsKeyDown(Enum.KeyCode.A) then
                -- Left - opposite of camera right direction
                direction = direction - rightVector
            end
            if UserInputService:IsKeyDown(Enum.KeyCode.D) then
                -- Right - follow camera right direction
                direction = direction + rightVector
            end
            if UserInputService:IsKeyDown(Enum.KeyCode.Space) then
                -- Up - global up
                direction = direction + Vector3.new(0, 1, 0)
            end
            if UserInputService:IsKeyDown(Enum.KeyCode.LeftControl) then
                -- Down - global down
                direction = direction + Vector3.new(0, -1, 0)
            end
            
            -- Face the direction you're moving towards
            if direction.Magnitude > 0.1 then
                bodyGyro.CFrame = CFrame.new(currentRootPart.Position, currentRootPart.Position + direction)
            else
                -- Face camera direction when not moving
                bodyGyro.CFrame = CFrame.new(currentRootPart.Position, currentRootPart.Position + lookVector)
            end
        end
        
        -- Apply movement
        if direction.Magnitude > 0 then
            bodyVelocity.Velocity = direction.Unit * flySpeed
        else
            bodyVelocity.Velocity = Vector3.new(0, 0, 0)
        end
    end)
end

-- Stop flying function
local function stopFlying()
    if not isFlying then return end
    
    isFlying = false
    flyButton.Text = "START FLYING"
    flyButton.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
    flyButton.BackgroundTransparency = 0.3
    
    local character = getCharacter()
    if not character then return end
    
    local humanoid = character:FindFirstChild("Humanoid")
    if humanoid then
        humanoid.PlatformStand = false
    end
    
    if bodyVelocity then
        bodyVelocity:Destroy()
        bodyVelocity = nil
    end
    
    if bodyGyro then
        bodyGyro:Destroy()
        bodyGyro = nil
    end
end

-- Connect button events
decreaseButton.MouseButton1Click:Connect(function()
    flySpeed = math.max(10, flySpeed - 10)
    updateSpeedDisplay()
end)

increaseButton.MouseButton1Click:Connect(function()
    flySpeed = math.min(200, flySpeed + 10)
    updateSpeedDisplay()
end)

flyButton.MouseButton1Click:Connect(function()
    if isFlying then
        stopFlying()
    else
        startFlying()
    end
end)

-- Toggle button click
toggleButton.MouseButton1Click:Connect(function()
    toggleUI()
end)

-- UI drag movement
mainFrame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        isDragging = true
        dragStart = input.Position
        dragStartPosition = mainFrame.Position
        
        local tween = TweenService:Create(mainFrame, TweenInfo.new(0.1), {
            BackgroundColor3 = Color3.fromRGB(20, 20, 20),
            BackgroundTransparency = 0.2
        })
        tween:Play()
    end
end)

mainFrame.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        isDragging = false
        
        local tween = TweenService:Create(mainFrame, TweenInfo.new(0.1), {
            BackgroundColor3 = Color3.fromRGB(10, 10, 10),
            BackgroundTransparency = 0.3
        })
        tween:Play()
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement and isDragging then
        local delta = input.Position - dragStart
        mainFrame.Position = UDim2.new(
            dragStartPosition.X.Scale,
            dragStartPosition.X.Offset + delta.X,
            dragStartPosition.Y.Scale,
            dragStartPosition.Y.Offset + delta.Y
        )
    end
end)

-- Hover effects with transparency
local function setupButtonHover(button)
    local originalColor = button.BackgroundColor3
    local originalTransparency = button.BackgroundTransparency
    
    button.MouseEnter:Connect(function()
        local tweenInfo = TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
        local tween = TweenService:Create(button, tweenInfo, {
            BackgroundColor3 = Color3.fromRGB(40, 40, 40),
            BackgroundTransparency = 0.1
        })
        tween:Play()
    end)
    
    button.MouseLeave:Connect(function()
        local tweenInfo = TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
        local tween = TweenService:Create(button, tweenInfo, {
            BackgroundColor3 = originalColor,
            BackgroundTransparency = originalTransparency
        })
        tween:Play()
    end)
end

-- Toggle button hover effects
toggleButton.MouseEnter:Connect(function()
    local tweenInfo = TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
    local tween = TweenService:Create(toggleButton, tweenInfo, {
        BackgroundColor3 = Color3.fromRGB(35, 35, 35),
        BackgroundTransparency = 0.1,
        ImageColor3 = Color3.fromRGB(200, 200, 200)
    })
    tween:Play()
end)

toggleButton.MouseLeave:Connect(function()
    local tweenInfo = TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
    local tween = TweenService:Create(toggleButton, tweenInfo, {
        BackgroundColor3 = Color3.fromRGB(25, 25, 25),
        BackgroundTransparency = 0.2,
        ImageColor3 = Color3.fromRGB(255, 255, 255)
    })
    tween:Play()
end)

-- Apply hover effects
setupButtonHover(decreaseButton)
setupButtonHover(increaseButton)
setupButtonHover(flyButton)

-- Update initial display
updateSpeedDisplay()

-- Handle player respawn
player.CharacterAdded:Connect(function(character)
    if isFlying then
        stopFlying()
    end
end)
